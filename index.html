<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Escape Game ‚Äì Acad√©mie des Arcanes</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&family=Uncial+Antiqua&display=swap" rel="stylesheet">
<style>
  :root{
    --gold:#ffd166;
    --ink:#0b1020;
    --violet:#6c43ff;
    --parch:#f5e6d3;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:"Uncial Antiqua", system-ui, serif;
    color:var(--parch);
    background:#03060f url("assets/background.jpg") center/cover fixed no-repeat;
    text-shadow:1px 1px 3px #000;
  }
  a{color:var(--gold)}
  .wrap{max-width:1100px;margin:0 auto;padding:24px}
  h1,h2{font-family:"Cinzel", serif;letter-spacing:.5px}
  /* Intro */
  #intro{
    margin:48px auto;
    background:linear-gradient(180deg, rgba(10,8,25,.9), rgba(5,5,12,.92));
    border:2px solid var(--gold);
    border-radius:18px; padding:28px; box-shadow:0 0 30px #000, 0 0 40px rgba(255,209,102,.2) inset;
    text-align:center;
  }
  #intro h1{font-size:2.4rem;color:var(--gold);text-shadow:0 0 12px #000, 0 0 26px var(--violet)}
  #introText{white-space:pre-wrap; line-height:1.6; font-size:1.15rem; text-align:justify}
  .btn{
    display:inline-block; padding:12px 22px; margin-top:18px; border:none; border-radius:10px; cursor:pointer;
    background:linear-gradient(90deg, #5b3df6, #a687ff); color:#fff; font-family:"Cinzel",serif; font-weight:700;
    box-shadow:0 0 16px #2b1fa0; transition:.2s transform;
  }
  .btn:hover{transform:translateY(-1px); background:linear-gradient(90deg,#a687ff,#5b3df6)}
  /* Zone de jeu */
  #hud{display:flex; gap:16px; align-items:center; justify-content:space-between; margin:10px 0}
  #timer{font-size:1.4rem; color:var(--gold)}
  #game{display:none}
  .enigme{
    background:rgba(0,0,0,.72); border:2px solid var(--gold); border-radius:14px; padding:18px; margin:18px 0;
    box-shadow:0 0 18px rgba(0,0,0,.6);
  }
  .enigme h3{margin:0 0 10px; color:#ffecc0}
  .enigme p{margin:0 0 10px; font-size:1.1rem}
  .enigme input{
    width:min(520px,90%); padding:10px; border-radius:8px; border:1px solid var(--gold);
    background:#131629; color:var(--gold); font-size:1rem;
  }
  .enigme .act{margin-top:10px}
  /* Popup indice (centre) */
  #indicePopup{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000;
    background:rgba(0,0,0,.65);
  }
  #indiceCard{
    background:linear-gradient(180deg, rgba(18,12,40,.98), rgba(10,8,25,.98));
    border:2px solid var(--gold); border-radius:14px; padding:22px; width:min(480px,92%);
    box-shadow:0 0 28px rgba(108,67,255,.6);
    text-align:center;
  }
  #indiceCard p{font-size:1.1rem}
  #indiceCard .btn{margin:6px}
  /* D√©cor cliquable (image oiseau + hotspots) */
  .decor{
    position:relative; margin:26px auto; max-width:980px; border:2px solid var(--gold); border-radius:16px;
    overflow:hidden; box-shadow:0 0 22px rgba(0,0,0,.6);
    background:#000;
  }
  .decor img{width:100%; display:block; opacity:.96}
  .hot{position:absolute; width:46px; height:46px; cursor:pointer; background:url("assets/spark.png") center/contain no-repeat; filter:drop-shadow(0 0 8px rgba(255,210,120,.9))}
  .hot:hover{transform:scale(1.1)}
  /* Overlay de fin */
  #overlay{
    display:none; position:fixed; inset:0; z-index:1200;
    background:radial-gradient( circle at 50% 45%, rgba(10,8,25,.94), rgba(0,0,0,.96));
    padding:28px; text-align:center;
  }
  #overlay h2{font-size:2.2rem; color:var(--gold)}
  #scores{margin-top:14px}
  table{border-collapse:collapse; margin:12px auto; min-width:300px}
  td,th{border:1px solid var(--gold); padding:8px 12px}
  .note{opacity:.8; font-size:.95rem}
</style>
</head>
<body>
<div class="wrap">

  <!-- AUDIO -->
  <audio id="musicIntro"   src="assets/intro.mp3"></audio>
  <audio id="musicAmbient" src="assets/ambient.mp3" loop></audio>
  <audio id="musicVictory" src="assets/victory.mp3"></audio>
  <audio id="musicDefeat"  src="assets/defeat.mp3"></audio>
  <audio id="soundIndice"  src="assets/twinkle.mp3"></audio>
  <audio id="soundMagic"   src="assets/mystical-chime.mp3"></audio>
  <audio id="soundSpark"   src="assets/sparkle.mp3"></audio>
  <audio id="soundCrackle" src="assets/fire-crackle.mp3"></audio>

  <!-- INTRO -->
  <section id="intro">
    <h1>Acad√©mie des Arcanes</h1>
    <div id="introText"></div>
    <button id="startBtn" class="btn">Commencer l‚Äôaventure</button>
    <div class="note">Astuce : clique sur les capes rouges cach√©es dans le d√©cor‚Ä¶</div>
  </section>

  <!-- JEU -->
  <section id="game">
    <div id="hud">
      <div id="timer">‚è≥ Temps restant : 60:00</div>
      <div>√ânigmes r√©solues : <span id="progress">0</span>/6</div>
    </div>

    <!-- D√©cor interactif (ton image) -->
    <div class="decor" id="decor">
      <img src="assets/oiseau.png" alt="D√©cor magique">
      <!-- Positionne les hotspots sur les capes rouges de ton image -->
      <div class="hot" style="top:82%; left:12%;" data-id="cape-bas"></div>
      <div class="hot" style="top:22%; left:82%;" data-id="cape-haut"></div>
    </div>

    <div id="enigmes"></div>
  </section>

  <!-- POPUP INDICE -->
  <div id="indicePopup" aria-hidden="true">
    <div id="indiceCard">
      <h3>üí° Indice</h3>
      <p id="indiceText"></p>
      <div>
        <button class="btn" id="acceptHint">Accepter (-2 pts)</button>
        <button class="btn" id="declineHint">Refuser</button>
      </div>
    </div>
  </div>

  <!-- OVERLAY FIN -->
  <section id="overlay">
    <h2 id="endTitle"></h2>
    <p id="endMsg"></p>
    <div id="scores"></div>
  </section>

</div>

<script>
/* ========= Intro ========= */
const introLines = [
  "Une ombre rampante s‚Äô√©tend dans les couloirs de l‚ÄôAcad√©mie‚Ä¶",
  "Le Sablier Noir s‚Äôest fissur√©. √Ä son dernier grain, la magie s‚Äô√©teindra.",
  "Gardien, rassemble ton courage. R√©sous les √©preuves, d√©joue les sortil√®ges,",
  "et rends au grimoire sa lumi√®re avant que les t√©n√®bres n‚Äôemportent tout."
];
const introTextEl = document.getElementById('introText');
(function typeIntro(i=0,j=0){
  if(i>=introLines.length){ document.getElementById('startBtn').style.display='inline-block'; return; }
  if(j<introLines[i].length){ introTextEl.textContent += introLines[i][j++]; setTimeout(()=>typeIntro(i,j), 28); }
  else { introTextEl.textContent += "\n\n"; setTimeout(()=>typeIntro(i+1,0), 450);}
})();

/* ========= Donn√©es du jeu ========= */
const enigmes = [
  {
    titre:"Enigme I ‚Äî L‚ÄôAtelier des Flammes",
    text:"Dans les flammes se cache la cl√© : F?E?. Reconstitue le mot.",
    answer:"feu",
    hint:"Regarde les cendres‚Ä¶ le mot n‚Äôattend qu‚Äôune lettre.",
  },
  {
    titre:"Enigme II ‚Äî Les Bougies du Vent",
    text:"Trois bougies br√ªlent. Le vent en √©teint deux. Combien restent allum√©es ?",
    answer:"1",
    hint:"Ne compte que les flammes qui subsistent.",
  },
  {
    titre:"Enigme III ‚Äî L‚ÄôHorloge des Ombres",
    text:"Je suis toujours devant toi mais jamais visible. Qui suis-je ?",
    answer:"avenir",
    hint:"Le contraire du pass√©.",
  },
  {
    titre:"Enigme IV ‚Äî Runes de la Crypte",
    text:"D√©chiffre : URYYB (indice : code rot13).",
    answer:"hello",
    hint:"Chaque lettre est d√©cal√©e de 13.",
  },
  {
    titre:"Enigme V ‚Äî Arithmomancie",
    text:"Quelle est la 9·µâ valeur de la suite 2,4,8,16‚Ä¶ ?",
    answer:"512",
    hint:"Double √† chaque pas √† partir de 1 : 2^9 ?",
  },
  {
    titre:"Enigme VI ‚Äî Sceau Final",
    text:"Je parle sans bouche, j‚Äôentends sans oreilles. Qui suis-je ?",
    answer:"echo",
    hint:"On t‚Äôentend dans les cavernes.",
  }
];

// score ‚Äúofficiel‚Äù (affich√© fin) et bonus fun (non compt√©s)
let boardScore = 0;
let solved = 0;
let time = 60*60; // 60 min
let timerInterval = null;
let gameEnded = false;

// gestion des indices al√©atoires (1 seul pop par √©nigme)
const hintState = enigmes.map(()=>({scheduled:false, shown:false, accepted:false, timeoutId:null}));

/* ========= UI helpers ========= */
const $ = s => document.querySelector(s);
const enigmesEl = $('#enigmes');

function mmss(sec){
  const m = Math.floor(sec/60), s = sec%60;
  return `${m}:${s<10?'0'+s:s}`;
}

/* ========= Lancement ========= */
$('#startBtn').onclick = () => {
  document.getElementById('musicIntro').pause(); // au cas o√π
  document.getElementById('intro').style.display='none';
  document.getElementById('game').style.display='block';
  document.getElementById('musicAmbient').play();
  $('#timer').textContent = `‚è≥ Temps restant : ${mmss(time)}`;
  renderEnigmes();
  startTimer();
  initDecor();
};

/* ========= Timer ========= */
function startTimer(){
  timerInterval = setInterval(()=>{
    if(gameEnded) return;
    time--;
    $('#timer').textContent = `‚è≥ Temps restant : ${mmss(time)}`;
    if(time<=0){ endGame(false); }
  },1000);
}
function stopAllTimers(){
  clearInterval(timerInterval);
  // annule les popups planifi√©s restants
  hintState.forEach(h => { if(h.timeoutId) clearTimeout(h.timeoutId); });
}

/* ========= Rendu √©nigmes + planification des indices ========= */
function renderEnigmes(){
  enigmesEl.innerHTML = '';
  enigmes.forEach((e,idx)=>{
    const card = document.createElement('div');
    card.className = 'enigme';
    card.id = `enigme-${idx}`;
    card.innerHTML = `
      <h3>${e.titre}</h3>
      <p>${e.text}</p>
      <div class="act">
        <input type="text" id="rep-${idx}" placeholder="Votre r√©ponse...">
        <button class="btn" onclick="checkAnswer(${idx})">Valider</button>
      </div>
      <div class="note" id="status-${idx}"></div>
    `;
    enigmesEl.appendChild(card);
    scheduleHint(idx); // planifie l‚Äôindice al√©atoire pour cette √©nigme
  });
}

/* ========= Indices al√©atoires (1 par √©nigme) ========= */
function scheduleHint(i){
  if(hintState[i].scheduled) return;
  hintState[i].scheduled = true;
  // d√©lai al√©atoire entre 35s et 150s apr√®s rendu
  const delay = 35000 + Math.floor(Math.random()*115000);
  hintState[i].timeoutId = setTimeout(()=>{
    if(gameEnded) return;
    const card = document.getElementById(`enigme-${i}`);
    // si d√©j√† r√©solue, pas d‚Äôindice
    if(card && card.style.display !== 'none' && !hintState[i].shown){
      showHintPopup(i);
    }
  }, delay);
}

function showHintPopup(i){
  hintState[i].shown = true; // ne repopera plus
  document.getElementById('soundIndice').play();
  $('#indiceText').textContent = enigmes[i].hint;
  $('#indicePopup').style.display = 'flex';

  $('#acceptHint').onclick = ()=>{
    hintState[i].accepted = true;
    boardScore = Math.max(0, boardScore-2); // p√©nalit√© ‚Äì2 (affich√©e en fin)
    $('#indicePopup').style.display = 'none';
    // marque l‚Äô√©nigme comme ayant utilis√© un indice
    const sEl = document.getElementById(`status-${i}`);
    if(sEl) sEl.textContent = "Indice utilis√© (-2 pts).";
  };
  $('#declineHint').onclick = ()=>{
    $('#indicePopup').style.display = 'none';
    const sEl = document.getElementById(`status-${i}`);
    if(sEl) sEl.textContent = "Indice refus√©.";
  };
}

/* ========= V√©rification r√©ponses ========= */
window.checkAnswer = (i)=>{
  if(gameEnded) return;
  const val = (document.getElementById(`rep-${i}`).value || '').trim().toLowerCase();
  if(!val) return;
  if(val === enigmes[i].answer.toLowerCase()){
    document.getElementById('soundMagic').play();
    // score : +10 si bon, -2 si indice accept√©
    boardScore += 10;
    if(hintState[i].accepted) boardScore -= 2;
    // masque la carte
    document.getElementById(`enigme-${i}`).style.display='none';
    solved++;
    $('#progress').textContent = `${solved}/${enigmes.length}`;
    if(solved >= enigmes.length){ endGame(true); }
  } else {
    // petite info d‚Äô√©chec
    const sEl = document.getElementById(`status-${i}`);
    if(sEl) sEl.textContent = "‚ùå Mauvaise r√©ponse.";
  }
};

/* ========= D√©cor interactif (bonus fun, non compt√©s) ========= */
function initDecor(){
  const used = new Set();
  document.querySelectorAll('.hot').forEach(h=>{
    h.addEventListener('click', ()=>{
      const id = h.dataset.id;
      if(used.has(id)) return;
      used.add(id);
      document.getElementById('soundSpark').currentTime = 0;
      document.getElementById('soundSpark').play();
      // bonus al√©atoire qui n‚Äôaffecte PAS le score final (boardScore)
      const effects = [
        ()=>{ time += 30; toast("‚è≥ +30 secondes ajout√©es au sablier !"); },
        ()=>{ // r√©v√®le premi√®re lettre de la prochaine √©nigme visible
          const idx = Array.from(document.querySelectorAll('.enigme'))
            .findIndex(el => el.style.display !== 'none');
          if(idx>=0){
            const input = document.querySelector(`#rep-${idx}`);
            const letter = enigmes[idx].answer[0];
            if(input && !input.value) input.value = letter;
            toast(`üî† Une lettre se r√©v√®le : ¬´ ${letter.toUpperCase()} ¬ª`);
          } else { toast("üí´ Une chaleur bienfaisante vous entoure‚Ä¶"); }
        },
        ()=>{ toast("üõ°Ô∏è Aegis Arcanum : protection √©th√©r√©e‚Ä¶ (bonus cosm√©tique)"); }
      ];
      effects[Math.floor(Math.random()*effects.length)]();
      h.style.opacity = .2; // visuel = consomm√©
      setTimeout(()=>{ h.style.display='none'; }, 600);
    });
  });
}
function toast(msg){
  // petit faux-toast via popup indice style simple
  const pad = document.createElement('div');
  pad.style.position='fixed'; pad.style.bottom='24px'; pad.style.left='50%';
  pad.style.transform='translateX(-50%)'; pad.style.background='rgba(20,20,40,.95)';
  pad.style.border='2px solid var(--gold)'; pad.style.borderRadius='10px';
  pad.style.padding='10px 14px'; pad.style.zIndex='1300'; pad.style.boxShadow='0 0 18px rgba(255,209,102,.35)';
  pad.textContent = msg;
  document.body.appendChild(pad);
  setTimeout(()=>pad.remove(), 2600);
}

/* ========= Fin de partie ========= */
function endGame(victory){
  if(gameEnded) return;
  gameEnded = true;
  stopAllTimers();
  document.getElementById('game').style.display='none';
  document.getElementById('indicePopup').style.display='none';
  document.getElementById('musicAmbient').pause();

  const title = document.getElementById('endTitle');
  const msg   = document.getElementById('endMsg');
  const scores = document.getElementById('scores');

  if(victory){
    title.textContent = "üåü Victoire !";
    msg.textContent   = "Les Arcanes brillent de nouveau : tu as sauv√© l‚ÄôAcad√©mie !";
    document.getElementById('musicVictory').play();
  } else {
    title.textContent = "‚ò†Ô∏è D√©faite‚Ä¶";
    msg.textContent   = "Le Sablier Noir s‚Äôest vid√© : la magie s‚Äô√©teint et l‚ÄôAcad√©mie sombre.";
    document.getElementById('musicDefeat').play();
    document.getElementById('soundCrackle').play();
  }

  // Tableau des scores (visible seulement √† la fin)
  const pseudo = prompt("Entre ton pseudo pour le tableau des scores :") || "Anonyme";
  const saved = JSON.parse(localStorage.getItem('arcane_scores')||'[]');
  saved.push({ pseudo, score: Math.max(0, boardScore), date: new Date().toLocaleString() });
  saved.sort((a,b)=>b.score-a.score);
  localStorage.setItem('arcane_scores', JSON.stringify(saved));

  const rows = saved.map(s=>`<tr><td>${s.pseudo}</td><td>${s.score}</td><td class="note">${s.date}</td></tr>`).join('');
  scores.innerHTML = `
    <h3>üèÜ Tableau des scores</h3>
    <table>
      <tr><th>Joueur</th><th>Score</th><th>Date</th></tr>
      ${rows}
    </table>
    <div class="note">Note : les bonus du d√©cor ne sont <u>pas</u> compt√©s dans le score final.</div>
  `;

  document.getElementById('overlay').style.display='block';
}
</script>
</body>
</html>
